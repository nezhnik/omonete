# Деплой на Reg.ru — главная инструкция

Документ фиксирует текущую логику металлов и шаги загрузки на Reg.ru, чтобы не терять контекст после доработок.

---

## Что заливать на Reg.ru

**Залить всё содержимое папки `out/`** в корень сайта на хостинге (например в `www/omonete.ru`).

В `out/` после сборки есть:
- HTML, JS, CSS
- **data/** — coins.json, coin-ids.json, mints.json, **metal-prices.json**, папка coins
- **cron-metal-prices.php** — скрипт для планировщика Reg.ru

После загрузки сайт сразу работает: графики металлов читают `/data/metal-prices.json`.

---

## Как собрать и залить (кратко)

1. **Локально** (при наличии DATABASE_URL в `.env`):
   ```bash
   npm run build:regru
   ```
   Команда по очереди: курсы ЦБ → бэкфилл меди → крон (БД → metal-prices.json) → сборка. В **out/** будет актуальный **data/metal-prices.json**.

2. Залить **содержимое папки out/** на Reg.ru (FTP/файловый менеджер).

3. На сервере в корне сайта должен быть **.env** с одной строкой:
   ```env
   DATABASE_URL=mysql://логин:пароль@хост:3306/база
   ```

4. В планировщике Reg.ru настроить крон (см. ниже), чтобы раз в день обновлялся `data/metal-prices.json`.

**Альтернатива:** если не запускали `build:regru`, можно сделать `npm run build`, залить `out/`, затем один раз на сервере создать пустой файл **.do-copper-backfill** и вручную запустить `php cron-metal-prices.php` — скрипт заполнит медь с 2006 года и удалит файл. Дальше крон по расписанию только подтягивает последние дни.

---

## Крон на Reg.ru

- **Команда:**  
  `/usr/bin/php /var/www/u2524954/data/www/omonete.ru/cron-metal-prices.php >/dev/null 2>&1`  
  (путь замените на актуальный к вашему сайту.)

- **Расписание:** ежедневно (например утром).

- **Ручной запуск (чтобы сразу обновить данные после деплоя):**  
  В панели «Выполнить команду» вставить ту же команду **без** `>/dev/null 2>&1`, нажать «Выполнить». Либо по SSH:  
  `php /var/www/.../cron-metal-prices.php`

---

## Логика данных по металлам (контекст доработок)

Чтобы не потерять контекст при следующих правках:

- **Источники:** драгметаллы (XAU, XAG, XPT, XPD) — ЦБ РФ; медь (XCU) — RusCable LME, те же даты что и у ЦБ (только рабочие дни, без выходных).
- **Медь в БД:** только **UPDATE** по существующим строкам (не создаём строк на выходные). Цена меди хранится в **руб/тройская унция** (как у драгметаллов). Формула: (USD/т / 1_000_000) × курс_ЦБ × 31.1035.
- **Нули:** в экспорт не попадают точки с ценой 0 (выходные/праздники отфильтрованы). В БД при необходимости можно было очистить строки с xau=xag=xpt=xpd=0 скриптом `scripts/clean-metal-prices-zero-rows.js`.
- **Выборка для графиков:**
  - **Месяц (1m):** каждый день = точка.
  - **Год (1y), 5 лет (5y), 10 лет (10y):** по **неделе** — в выборку попадает **день с максимальной ценой по этому металлу за неделю** (weekMax). Так пики не теряются при смене периода.
  - **Все (all):** по **месяцу** — в выборку попадает **день с максимальной ценой по этому металлу за месяц** (monthMax).
- **График меди на сайте:** медь подтягивается из того же `metal-prices.json` (XCU), скелетон и анимации как у остальных металлов.

**Скрипты:**
- `scripts/cron-metal-prices.js` — крон (Node): ЦБ + RusCable → БД → public/data/metal-prices.json.
- `scripts/backfill-copper-ruscable.js` — один раз догнать медь с 2006 года (только UPDATE по существующим датам).
- `scripts/clean-metal-prices-zero-rows.js` — одноразовая очистка БД от строк с нулями по драгметаллам.
- `scripts/migrate-copper-to-per-ounce.js` — одноразовая миграция xcu из руб/г в руб/унция (уже выполнена).
- `scripts/clean-metal-prices-from-out.js` — опционально: удаляет metal-prices.json из out перед заливкой, чтобы на сервере обновлялся только файл от крона.

---

## Проверка после деплоя

- Открыть сайт и страницу «Графики» — все металлы, включая медь, с актуальными данными.
- Открыть в браузере `https://ваш-домен.ru/data/metal-prices.json` — должны быть периоды 1m, 1y, 5y, 10y, all и серии XAU, XAG, XPT, XPD, XCU.

---

## Кратко

Залить **out/** на Reg.ru → настроить крон и .env → при необходимости один раз запустить крон вручную. Готовое решение после деплоя — статика из out и ежедневное обновление metal-prices.json кроном.
