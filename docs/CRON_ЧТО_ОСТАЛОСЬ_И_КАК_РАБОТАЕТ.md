# Крон: что осталось и как работает

## Что уже готово

- **БД заполнена:** курс доллара с 1992 года (`cbr_rates`), металлы ЦБ с 2003 года и медь с 2006 года (`metal_prices`, в т.ч. `xcu`).
- **Скрипты:** Node-крон (`scripts/cron-metal-prices.js`) и PHP-крон для Reg.ru (`public/cron-metal-prices.php` → в сборке попадает в `out/cron-metal-prices.php`).
- **Фронт:** графики и портфолио читают только `/data/metal-prices.json` (без запросов к API).

---

## Что осталось сделать один раз

1. **Залить сайт на Reg.ru**  
   Содержимое папки **`out/`** скопировать в корень сайта на хостинге (в т.ч. `data/metal-prices.json`, `cron-metal-prices.php`).

2. **Настроить доступ к БД на сервере**  
   В корне сайта на Reg.ru создать файл **`.env`** с одной строкой:
   ```env
   DATABASE_URL=mysql://логин:пароль@хост:порт/база
   ```
   (те же данные, что в панели Reg.ru для MySQL.)

3. **Добавить задание в планировщик (CRON)**  
   В панели Reg.ru: **Планировщик заданий** → новое задание:
   - **Команда:**  
     `/usr/bin/php /полный/путь/к/корню/сайта/cron-metal-prices.php`  
     (путь к вашему домену, например `/var/www/uXXXX/data/www/omonete.ru/cron-metal-prices.php`).
   - **Расписание:** раз в день, например в 8:00 (в рабочие дни ЦБ публикует данные утром).

После этого крон будет сам обновлять данные и файл `data/metal-prices.json` на сервере.

---

## Как работает крон (один запуск)

Один запуск скрипта (Node или PHP) делает по шагам:

### 1. Решение: запускаться ли сегодня

- **Рабочий день (пн–пт):** выполняются запросы к ЦБ и RusCable, затем экспорт в JSON.
- **Выходной (сб/вс):** запросы к ЦБ не делаются (у ЦБ нет новых курсов), экспорт из БД в JSON **всё равно выполняется** — в файле остаются данные последнего рабочего дня.

Принудительный запуск с запросами в выходной:  
`FORCE_METAL_CRON=1 node scripts/cron-metal-prices.js` (для Node).

### 2. Обновление курса доллара (только в рабочий день)

- **Таблица:** `cbr_rates`.
- **Источник:** cbr-xml-daily (текущий день + архив за последние 3 дня).
- **Что меняется:** добавляются/обновляются строки за последние 3 дня (`date`, `usd_rub`).
- **Зачем:** курс нужен для пересчёта меди из USD/т в руб/г.

### 3. Обновление цен металлов ЦБ (только в рабочий день)

- **Таблица:** `metal_prices` (поля `xau`, `xag`, `xpt`, `xpd`).
- **Источник:** ЦБ РФ SOAP API (DragMetDynamic) за последние 3 дня.
- **Что меняется:** добавляются/обновляются строки по датам за последние 3 дня (золото, серебро, платина, палладий).

### 4. Обновление меди RusCable (только в рабочий день)

- **Таблица:** `metal_prices` (поле `xcu`).
- **Источник:** RusCable LME API за последние 3 дня; курс для пересчёта — из `cbr_rates`.
- **Что меняется:** обновляются значения `xcu` только за последние 3 дня (руб/г).  
  Вся история меди с 2006 года уже в БД после однократного бэкфилла; крон её не перезаливает.

### 5. Экспорт в JSON (всегда)

- **Файл:** `data/metal-prices.json` (на сервере — в корне сайта, папка `data/`).
- **Источник данных:** полная выборка из БД `metal_prices` (все даты, все металлы включая медь).
- **Что делается:** из БД формируются периоды 1m, 1y, 5y, 10y, all и записываются в файл.  
  Сайт отдаёт этот файл по адресу `/data/metal-prices.json`; графики и портфолио читают только его.

### 6. Статус последнего запуска (только PHP-крон на Reg.ru)

- **Файл:** `data/cron-metal-last.json`.
- **Содержимое:** дата/время последнего запуска, сообщение, последняя точка по 1m.
- **Проверка:** откройте в браузере `https://ваш-домен.ru/data/cron-metal-last.json` — если дата свежая, крон сработал.

---

## Какие данные меняет крон

| Что | Таблица / файл | Когда обновляется |
|-----|-----------------|-------------------|
| Курс USD/RUB | `cbr_rates` | В рабочий день: последние 3 дня |
| Золото, серебро, платина, палладий | `metal_prices` (xau, xag, xpt, xpd) | В рабочий день: последние 3 дня |
| Медь (руб/г) | `metal_prices.xcu` | В рабочий день: последние 3 дня |
| Файл для сайта | `data/metal-prices.json` | Каждый запуск (из текущего состояния БД) |
| Статус крона (Reg.ru) | `data/cron-metal-last.json` | Каждый запуск PHP-скрипта |

Историю (все годы) крон не подгружает — она уже в БД после однократного запуска `npm run backfill:all` (или бэкфилла курсов + меди + одного запуска крона).

---

## Где какой крон использовать

- **Локально или свой VPS с Node:**  
  `npm run metal-prices:cron` или  
  `node scripts/cron-metal-prices.js`  
  В crontab: раз в день, например `0 8 * * 1-5 cd /путь/к/omonete-app && node scripts/cron-metal-prices.js`.

- **Reg.ru (только PHP):**  
  В планировщике Reg.ru указать запуск  
  `php /путь/к/корню/сайта/cron-metal-prices.php`  
  раз в день. Скрипт читает `.env` из корня сайта и пишет `data/metal-prices.json` и `data/cron-metal-last.json` там же.

---

## Краткий чеклист

- [ ] БД заполнена (курсы с 1990-х, медь с 2006) — уже сделано.
- [ ] Залит `out/` на Reg.ru (в т.ч. `data/metal-prices.json`, `cron-metal-prices.php`).
- [ ] В корне сайта на сервере создан `.env` с `DATABASE_URL`.
- [ ] В планировщике Reg.ru добавлено задание: раз в день запуск `php .../cron-metal-prices.php`.
- [ ] Проверка: открыть `https://ваш-домен.ru/data/cron-metal-last.json` после следующего запуска крона.

После этого всё будет обновляться автоматически раз в день.
