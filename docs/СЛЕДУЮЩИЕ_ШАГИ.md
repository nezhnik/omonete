# Следующие шаги: металлы ЦБ, крон, статика

Реализовано по схеме из [СХЕМА_ВЗАИМОДЕЙСТВИЯ.md](./СХЕМА_ВЗАИМОДЕЙСТВИЯ.md).

---

## Что уже сделано в коде

1. **Таблица БД** — SQL в `scripts/metal-prices-table.sql` (таблица `metal_prices`: date, xau, xag, xpt, xpd).
2. **Скрипт крона** — `scripts/cron-metal-prices.js`: один запуск делает (1) запрос к ЦБ → запись в MySQL, (2) чтение из БД → запись в `public/data/metal-prices.json`.
3. **Фронт** — страницы «Графики» и «Портфолио» сначала запрашивают `/data/metal-prices.json`, при отсутствии — API `/api/metal-prices`.
4. **npm-скрипт** — `npm run metal-prices:cron` запускает скрипт крона.

---

## Что сделать на Reg.ru (один раз)

### 1. Создать таблицу металлов в MySQL

- В панели Reg.ru открой **phpMyAdmin** (или консоль MySQL).
- Выбери базу, в которой уже лежат `coins` и `mints`.
- Выполни SQL из файла `scripts/metal-prices-table.sql`:
  - создаётся таблица `metal_prices` с полями `date`, `xau`, `xag`, `xpt`, `xpd`.

### 2. Настроить крон раз в день

- В панели Reg.ru: **Планировщик CRON**.
- Добавь задачу:
  - **Расписание:** раз в день, например `0 6 * * *` (каждый день в 06:00).
  - **Команда:** вызов скрипта с доступом к БД и к папке сайта.

Как именно вызывать — зависит от хостинга:

- **Если на хостинге есть Node.js:**  
  Команда вида:  
  `cd /путь/к/omonete-app && node scripts/cron-metal-prices.js`  
  (путь уточни в панели; в .env на сервере должен быть `DATABASE_URL`.)

- **Если только PHP:**  
  Нужен отдельный PHP-скрипт, который:
  1. Запрашивает ЦБ (SOAP, как в [описании ЦБ](https://www.cbr.ru/development/dws/)), парсит ответ.
  2. Подключается к MySQL и вставляет/обновляет строки в `metal_prices`.
  3. Выбирает данные из `metal_prices`, формирует JSON для периодов 1w, 1m, 1y, 5y, 10y и записывает файл в каталог сайта (например, `public/data/metal-prices.json` или куда отдаётся статика).

После первого успешного запуска крона в `public/data/` появится (или обновится) `metal-prices.json`, графики и портфолио начнут брать данные из него.

### 3. Первый запуск вручную (рекомендуется)

Локально (с настроенным `.env` и `DATABASE_URL` на твою БД):

```bash
npm run metal-prices:cron
```

Скрипт подтянет из ЦБ последние ~35 дней, заполнит таблицу и создаст `public/data/metal-prices.json`. После этого можно закоммитить этот файл или один раз залить его на Reg.ru, чтобы графики сразу работали из статики.

---

## Монеты и статьи (напоминание)

- **Выгрузка в статику:** уже есть скрипт `scripts/export-coins-to-json.js` (`npm run data:export` входит в `build`). Он пишет в `public/data/` (coins.json, coins/*.json, при необходимости mints.json).
- **Обновление на Reg.ru:** после выгрузки нужно обновить файлы на хостинге (FTP или копирование в папку сайта). Можно автоматизировать одним скриптом: экспорт из MySQL → загрузка по FTP (см. схему).

---

## Краткий чек-лист

- [ ] Выполнить `scripts/metal-prices-table.sql` в MySQL на Reg.ru.
- [ ] Один раз запустить `npm run metal-prices:cron` (локально или на сервере), проверить появление `public/data/metal-prices.json`.
- [ ] Настроить в Reg.ru крон на ежедневный запуск скрипта (или PHP-аналога).
- [ ] При необходимости автоматизировать выгрузку монет (MySQL → JSON → FTP/копирование на хостинг).
