# Справочник: крон, металлы, курс доллара

Единый документ, чтобы не путаться в настройках и данных.

---

## 1. Подписи на графиках (месяцы и даты)

**Что это такое.** У каждого графика (Золото, Серебро, Платина, Палладий, Медь) у каждой точки данных есть поле **`label`** — подпись даты. Она показывается:
- при **наведении** на график (например: «15 окт. 25» для периода «Год»);
- если не наведён курсор — показывается общая подпись периода: «За год», «За месяц» и т.д.

**Формат подписей (одинаковый у всех металлов):**

| Период | Формат label | Пример |
|--------|----------------|--------|
| Месяц (1m) | день + короткий месяц | «15 янв.» |
| Год (1y) | день + короткий месяц + год | «15 окт. 25» |
| 5 лет / 10 лет | по одной точке за неделю, тот же формат что и год | «12 мар. 25» |
| Все (all) | короткий месяц + год | «окт. 25» |

Подписи формируются в крон-скриптах (Node и PHP) при сборке `metal-prices.json` и на фронте не пересчитываются. Русские короткие месяцы: янв., фев., мар., апр., мая, июн., июл., авг., сен., окт., нояб., дек.

---

## 2. Источники данных

| Данные | Источник | Куда пишется |
|--------|----------|--------------|
| **Курс доллара ЦБ (USD/RUB)** | cbr-xml-daily.ru (JSON по дате) | Таблица `cbr_rates`: поля `date`, `usd_rub` |
| **Драгметаллы (XAU, XAG, XPT, XPD), руб/г** | ЦБ РФ, SOAP-сервис DragMetDynamic | Таблица `metal_prices`: поля `date`, `xau`, `xag`, `xpt`, `xpd` |
| **Медь (XCU), руб/г** | RusCable (LME, цена в USD/т) + курс из `cbr_rates` | Таблица `metal_prices`: поле `xcu`; формула: `(USD/т / 1_000_000) × usd_rub` |

ЦБ даёт данные только в рабочие дни (пн–пт). RusCable — по своим датам; пересчёт в рубли идёт только по тем датам, для которых есть курс в `cbr_rates`. Полная история меди по годам заполняется **один раз** скриптом `backfill-copper-ruscable.js`; без него в графиках за 2023 и прошлые годы по меди будут нули (крон обновляет медь только за последние 3 дня).

**Отображение на сайте:** в данных и БД медь хранится в **руб/г** (как и остальные металлы). На странице «Графики» для меди цена показывается в **руб/кг** (×1000), чтобы отображалось привычное значение «около 930 ₽/кг», а не «0,93 ₽/г». В портфолио расчёт стоимости меди по монетам по-прежнему идёт от руб/г (цена за грамм × вес в граммах).

---

## 3. Таблицы БД

**`cbr_rates`**
- `date` (DATE, PK) — дата
- `usd_rub` (DECIMAL) — курс доллара ЦБ на эту дату

**`metal_prices`**
- `date` (DATE, UNIQUE) — дата
- `xau`, `xag`, `xpt`, `xpd`, `xcu` (DECIMAL) — цена за грамм в рублях (ЦБ для драгметаллов, расчёт для меди)

История один раз догружается скриптами бэкфилла; крон обновляет только последние дни (по умолчанию 3).

---

## 4. Крон-задачи

Обе делают одно и то же: обновляют курсы ЦБ за последние 3 дня, металлы ЦБ за 3 дня, медь за 3 дня, затем экспортируют из БД в JSON.

### 4.1 Node.js (локально)

- **Скрипт:** `scripts/cron-metal-prices.js`
- **Запуск:** `npm run metal-prices:cron` или `node scripts/cron-metal-prices.js`
- **Нужно:** Node, `.env` с `DATABASE_URL=mysql://...`
- **Куда пишет JSON:** `public/data/metal-prices.json` (при деплое копируется в `out/data/`)

Выходные (сб/вс) по умолчанию запросы к ЦБ не выполняет; экспорт из БД в JSON — всегда. Принудительный запуск: `FORCE_METAL_CRON=1 node scripts/cron-metal-prices.js`.

### 4.2 PHP (на Reg.ru)

- **Скрипт:** `cron-metal-prices.php` (в корне проекта и в `public/` → попадает в `out/` при сборке)
- **Запуск в планировщике Reg.ru:**  
  `/usr/bin/php /var/www/.../omonete.ru/cron-metal-prices.php >/dev/null 2>&1`
- **Нужно:** PHP, доступ к MySQL (тот же, что у сайта), в корне сайта файл `.env` с `DATABASE_URL=mysql://...` или переменная окружения
- **Куда пишет JSON:** `data/metal-prices.json` относительно корня сайта (т.е. рядом с тем, что залито из `out/`)

Логика рабочих дней и принудительного запуска — как в Node (по будням обновляет ЦБ и RusCable, в любой день — экспорт в JSON).

**Проверка работы крона на Reg.ru:** после запуска задачи скрипт пишет файл `data/cron-metal-last.json`. Откройте в браузере `https://ваш-домен.ru/data/cron-metal-last.json` — там будут поле `lastRun` (время последнего запуска), `lastRunLabel` (читаемая дата/время) и `message`. Если дата свежая, крон выполнился успешно.

---

## 5. Файл metal-prices.json

**Путь на сайте:** `/data/metal-prices.json` (статический файл из `out/data/metal-prices.json` или обновлённый кроном на сервере).

**Структура:** объект с ключами периодов `"1m"`, `"1y"`, `"5y"`, `"10y"`, `"all"`. Значение каждого периода:

```json
{
  "ok": true,
  "period": "1y",
  "source": "static",
  "XAU": [{"label": "15 окт. 25", "value": 12837.78}, ...],
  "XAG": [...],
  "XPT": [...],
  "XPD": [...],
  "XCU": [...]   // есть, если в БД есть ненулевые xcu
}
```

Графики и портфолио читают **только** этот файл; API цен металлов не вызывается.

---

## 6. Где что лежит в проекте

| Назначение | Файл/папка |
|------------|------------|
| Крон Node | `scripts/cron-metal-prices.js` |
| Крон PHP (для Reg.ru) | `cron-metal-prices.php`, `public/cron-metal-prices.php` |
| Бэкфилл курсов ЦБ (один раз) | `scripts/backfill-cbr-rates.js` |
| Бэкфилл меди RusCable (один раз) | `scripts/backfill-copper-ruscable.js` |
| Чтение данных на сайте | Страницы загружают `/data/metal-prices.json` (графики — все периоды, портфолио — период 1m) |
| Деплой на Reg.ru | `DEPLOY_REG_RU.md` |
| Подробнее про крон и сбои | `docs/METAL_CRON_HOW_IT_WORKS.md` |

---

## 7. Краткая цепочка

1. Крон (Node или PHP) раз в день: ЦБ (курс + металлы) + RusCable (медь) → БД → экспорт в `metal-prices.json`.
2. Сайт отдаёт статику; фронт запрашивает `/data/metal-prices.json` и строит графики по полям `XAU`, `XAG`, `XPT`, `XPD`, `XCU` с подписями `label` (даты/месяцы в одном формате у всех металлов).
