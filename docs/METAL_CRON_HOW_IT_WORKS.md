# Как работает обновление цен металлов и меди (одна крон-задача)

## Один запуск крона = один скрипт

Команда (раз в день, лучше утром в рабочий день):

```bash
node scripts/cron-metal-prices.js
```

В одном запуске по порядку выполняется:

1. **Таблицы** — создаются/проверяются `metal_prices` и `cbr_rates`.
2. **Курсы доллара ЦБ** — запросы к cbr-xml-daily за **последние 3 дня** → запись в `cbr_rates` (date, usd_rub).
3. **Металлы ЦБ (золото, серебро, платина, палладий)** — один запрос к ЦБ за последние 3 дня → запись в `metal_prices` (xau, xag, xpt, xpd).
4. **Медь** — один запрос к RusCable за **последние 3 дня** (как и металлы) → для каждой даты курс из `cbr_rates` → обновление `metal_prices.xcu`.
5. **Экспорт** — **всегда**: из БД читаются все данные → запись в `public/data/metal-prices.json`. Если ЦБ или RusCable были недоступны, в файл попадают данные с последней успешной выгрузки — сайт продолжает показывать актуальные на наш взгляд данные.

---

## Откуда данные

| Что | Источник | Куда |
|-----|----------|------|
| Курс USD/RUB | cbr-xml-daily.ru (последние дни) | `cbr_rates` |
| XAU, XAG, XPT, XPD | ЦБ РФ SOAP (DragMetDynamic) | `metal_prices` |
| Медь (USD/т) | RusCable LME | по курсу из `cbr_rates` → руб/г в `metal_prices.xcu` |

Полная история курсов ЦБ один раз заливается скриптом `backfill-cbr-rates.js`. Полная история меди — скриптом `backfill-copper-ruscable.js`. Крон только «добивает» последние дни.

---

## Выходные и праздники ЦБ

- В **субботу и воскресенье** скрипт по умолчанию **не ходит** в ЦБ и не экспортирует JSON (сразу выходит с сообщением).
- Чтобы всё равно выполнить обновление (например, медь и экспорт старых данных):  
  `FORCE_METAL_CRON=1 node scripts/cron-metal-prices.js`

---

## Возможные проблемы

### 1. Нет курса ЦБ на дату → медь не обновится на эту дату

- Крон подтягивает курсы и медь за **последние 3 дня**. Для дат без курса в `cbr_rates` xcu не пересчитается.
- **Что сделать:** один раз выполнить `node scripts/backfill-cbr-rates.js`, чтобы в БД была история курсов с 1992 года.

### 2. В metal_prices нет строки на дату

- Медь только **обновляет** существующие строки (`UPDATE metal_prices SET xcu = ? WHERE date = ?`). Новые строки не создаются.
- В `metal_prices` попадают только даты, по которым ЦБ отдал металлы (рабочие дни РФ). Субботы/воскресенья в ЦБ нет → строк на эти даты может не быть → xcu для них не запишется.
- **Итог:** медь в рублях есть только по тем датам, где есть и металлы ЦБ, и курс в `cbr_rates`. Для графика это нормально: выходные всё равно часто не отображаются.

### 3. ЦБ или RusCable недоступны / таймаут

- Запросы к ЦБ и RusCable обёрнуты в try/catch: при ошибке в лог пишется сообщение, скрипт **не падает**.
- **Экспорт в JSON выполняется всегда** — в файл попадает то, что уже есть в БД (последняя успешная выгрузка). Сайт продолжит показывать эти данные до следующего успешного обновления.
- Рекомендуется смотреть логи крона и при повторяющихся сбоях — разбираться с сетью или источником.

### 4. Разное время публикации данных

- ЦБ и RusCable обновляются в разное время. За один запуск крона ты получаешь «снимок» на момент запуска: что уже опубликовано — то и попадёт в БД и в JSON.
- Если крон гонять рано утром, часть данных за «сегодня» может появиться только следующим запуском — это ожидаемо.

### 5. Рег.ру и статика

- На хостинге только статика (папка `out/`). После крона нужно заново собрать проект (`npm run build`) и залить обновлённый `out/` (в т.ч. `out/data/metal-prices.json`). Или крон должен стоять на машине, где после скрипта выполняется билд и деплой — тогда актуальный JSON всегда уедет на сервер.

### 6. По меди за 2023 (и за прошлые годы) в графике нули

- **Причина:** крон обновляет медь только за **последние 3 дня**. За все прошлые даты (2023, 2022 и т.д.) поле `xcu` в БД так и остаётся 0, если один раз не прогнать полный бэкфилл меди.
- **Что сделать один раз** (на той машине, где есть доступ к той же БД, что использует сайт/крон):
  1. Убедиться, что в БД есть курсы ЦБ за нужные годы:  
     `node scripts/backfill-cbr-rates.js`
  2. Заполнить медь за все годы (2006–сегодня):  
     `node scripts/backfill-copper-ruscable.js`  
     Скрипт запросит RusCable по годам и проставит `metal_prices.xcu` для всех дат, где есть и строка в `metal_prices`, и курс в `cbr_rates`.
  3. После этого снова запустить крон (или PHP-скрипт на Reg.ru), чтобы перезаписать `metal-prices.json` из БД и залить обновлённый файл на сайт.

После бэкфилла график «10 лет» и «Все» по меди будут с нормальными ценами.

---

## Кратко

- **Один крон** — один запуск `node scripts/cron-metal-prices.js`: курсы ЦБ и металлы за 3 дня, медь за 3 дня, затем **всегда** экспорт в JSON (при сбое API в файле остаются данные с последней успешной выгрузки).
- **Проблемы:** нет курса в БД на дату → медь по этой дате не обновится; нет строки в `metal_prices` (например выходной) → xcu для этой даты не пишется; после крона нужен билд и деплой, чтобы на сайте был свежий `metal-prices.json`.
